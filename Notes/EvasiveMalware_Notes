###############################################################################
#                            Evasive Malware                                  #
#                         Start Date: Jan 2 2024                              #
#                         End Date:                                           #
#                         Status:                                             #
###############################################################################


                        Windows Foundational Concepts 
_______________________________________________________________________________
Windows Architecture Overview

															+--------------+
															| Applications |
															+--------------+
																		 ↓↑
								+-----------+   +---------+
								| User-mode | → | Windows |
								|  drivers  | ← |   API   |
								+-----------+   +---------+
	User mode           Ʌ |           Ʌ |
	--------------------|-|-----------|-|----------
	Kernel mode         | v           | v
									+---------+   +---------+
									| Kernel  | → | Windows |
									| drivers | ← |  Kernel |
									+---------+   +---------+
											 ↑↓            ↑↓
								+----------------------------+
								| Hardware abstraction layer |
								+----------------------------+
															↑↓       
												 +----------+
												 | Hardware |
												 +----------+

	Applications:  These are the software and programs that a user runs

	Windows API:   What apps rely on in order to function
	
	Drivers:       Control various devices on the system & provide an abstraction
	               layer between the devices and programs
	
	Hardware       Provides an interface that device drivers can use to 
	abstration     communicate with underlying system hardware 
	layer: 


Objects and Handles
	Objects are instances of a certain type of resource (file, process, 
	security token)
	They are simply data structures, typically stored in kernel memory

	A process uses a unique identifier known as handle to access an object
	Each process may have multiple handles for various objects 
	Handles are managed in a process's handle table, which contain pointers to 
	the objects in kernel memory

	        +---------+
	        | Process |
	user    +---------+
	    		     |
	-------------+-------------------------------------------------------
  kernel       |
	             v 
	+-------------------------+         +-----------------------+
	|  Process handle table   |         | Object manager header |
	+------------+------------+         +-----------------------+
	| Handle 0x1 | Object ptr |-------> | Object data structure |
	+------------+------------+         +-----------------------+
  | Handle 0x4 | Object ptr |         
	+------------+------------+         
  | Handle 0x8 | Object ptr |
	+------------+------------+
  | Handle ... | Object ptr |
	+------------+------------+

	Object Manager is responsible for tracking all Windows objects, sharing among
	processes, and protecting from unauthorized access


Windows API
Windows Native API: lower level API 
	- Windows Native API functions have prefix Nt or Zw
	- Windows API -> Windows Native API -> kernel 

_______________________________________________________________________________
Process Internals
	- processes are represented in kernel addr space as objects called EPROCESS structs
	- Each process has its own EPROCESS structure that contains ptrs to elements
		like list of handles the process has open, Process Environment Block (PEB)
		which is a struct that contains vital info about the process
	- EPROCESS structs consist of a doubly linked list 

	Process Environment Blocks
		- The PEB memory struct contains info about a running process that the kernel
			needs to communicate with that process & info for icp 
		- Each running process has its own PEB that's stored in user-mode addr space 
			inside that process memory 

	Thread Environment Blocks
		- data struct that contains info for a process's running threads

_______________________________________________________________________________
PE File Format
	Headers & Sections
		- metadata, PE header 
		- section header which is metadata related to each of the file's sections
		- .text, .rdata, .bss, .data, .rsrc, .idata (imports), .edata (exports)
		- .idata contains info about functions that the PE file will import at runtime
			Once PE file is executed, the program will load the libs & funcs referenced
			here into memory and build its import addr table (IAT) which maps the 
			imported Windows API functions to their addresses in memory
		- .edata contains into about the functions that the PE file exports to other
			programs exports have their own table export addr table
		- In practice .edata & .idata sections are often contained in .rdata section

	Windows PE Loading Process
		1. Windows creates a new EPROCESS data struct for application & assigns new pid
		2. Windows initializes the virtual memory for the process, creates the PEB structure,
			 and loads two libs ntdll.dll & kernel32.dll. Initializes the PE loader
		3. The PE loader parses the DOS, PE, & optional headers of the PE file to 
			 gather info required to successfully execute the file
		4. The PE loader parses the section header to prepare for mapping these sections into 
			 memory. The loader maps each section into virtual memory within the new process
		5. The PE loader loads all libs referenced in the imports & resolves all addrs for
			 the functions required. All addrs are then stored in the IAT inside the process
		6. A new thread is created inside the current process & the loader executes 
			 the first bytes of code in the executable (usually .text section)

	   PE file          Virtual Memory
	+------------+      +------------+
	| DOS header |      | DOS header |
	+------------+      +------------+
	| PE header  |      |    ...     |
	+------------+      +------------+
	|    ...     |      | PE header  |
	+------------+      +------------+
	|   .text    |      |    ...     |
	+------------+      +------------+
	|   .data    |      |   .text    | 
	+------------+      +------------+
	|   .rdata   |      |    ...     |
	+------------+      +------------+
	|    ...     |      |   .data    |
	+------------+      +------------+
	                    |    ...     |
											+------------+
											|   .rdata   |
											+------------+
											|    ...     |
											+------------+

	Each section in the PE file is individually mapped into memory, but it appears
	expanded in virtual memory as there are often regions of memory between each
	section

