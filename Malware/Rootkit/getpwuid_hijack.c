// Function interposition for getpwuid to screw with whoami cmd

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <pwd.h>
#include <sys/types.h>
#include <dlfcn.h>

// This is overriding the name output from whoami
/*struct passwd* getpwuid(uid_t uid) {
  printf("Reminder that this is a rootkit\n");

  struct passwd *result;
  result = (struct passwd *)malloc(sizeof(struct passwd));
  if(result == NULL) {
    perror("Malloc failure\n");
    return NULL;
  }

  // Define the name
  result->pw_name = "root";

  return result;
}
*/

// Function pointer for original getpwuid function
typedef struct passwd* (*pw_t)(uid_t);

struct passwd* getpwuid(uid_t uid) {
  printf("Reminder that this is a rootkit\n");
  
  pw_t original_getpwuid = (pw_t)dlsym(RTLD_NEXT, "getpwuid");

  struct passwd* pass;
  pass = original_getpwuid(uid);

  printf("pw_name: %s\n", pass->pw_name);
  printf("pw_name: %s\n", pass->pw_passwd);

  return pass;
}
