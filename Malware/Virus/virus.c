#include <stdio.h>
#include <libgen.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <dirent.h>


char *findCleanELF(ino_t self);
void executePayload();

int main(int argc, char** argv) {

  // Copy virus into memory
  char *name = basename(argv[0]);
  int virus_fd = open(name, O_RDONLY);
  if(virus_fd == -1) { 
    perror("error opening file");
    return 1; 
  }

  // TODO: This is wrong and has to change
  struct stat st;
  fstat(virus_fd, &st);
  int virus_size = st.st_size;
  // printf("size of file: %d\n", virus_size);

  // Find a clean ELF file to infect
  findCleanELF(st.st_ino);

  /*
  // Read into memory
  char virus_buffer[virus_size];
  if(read(virus_fd, virus_buffer, virus_size) < virus_size) {
    perror("error reading virus");
    return 1;
  }

  // Copy virus into tmp file
  char *tmp_name = "tmp_virus";
  int tmp_fd = open(tmp_name, O_CREAT | O_RDWR);
  if(tmp_fd == -1) {
    perror("error opening tmp file");
    return 1;
  }
  if(write(tmp_fd, virus_buffer, virus_size) == -1) {
    perror("error writing to tmp file");
    return 1;
  } */

  // Execute the virus payload
  // executePayload();

  // close(tmp_fd);
  close(virus_fd);

  return 0;
}


char *findCleanELF(ino_t self) {
  // open current directory
  DIR *dir = opendir(".");
  struct dirent *entry;
  while((entry = readdir(dir)) != NULL) {
    if(entry->d_ino == self) { continue; }
    printf("%s\n", entry->d_name);
  }
}

void executePayload() {
  printf("Virus Payload\n");
}
